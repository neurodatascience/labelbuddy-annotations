---
jupytext:
  text_representation:
    extension: .md
    format_name: myst
    format_version: 0.13
    jupytext_version: 1.14.1
kernelspec:
  display_name: Python 3
  language: python
  name: python3
---
# Biomedical literature annotations

This {{ "[repository]({})".format(repo_url) }} stores manual annotations (a.k.a tagging, labelling) of biomedical scientific publications.
Examples of information that has been annotated in some documents are the number of study participants, their mean age, or the imaging modality.
Such annotations have diverse uses such as studying the evolution of a scientific field's methods, evaluating automatic information extraction systems, or informing meta-analyses.

The documents found here are journal articles from {{ pmc_home }}, collected using {{ pubget_home }}.
The annotations are made with {{ labelbuddy_home }}, and data is stored in {{ lb }}'s (JSON) format.

This page provides a brief overview of the repository's content, and the rest of the documentation illustrates how to use and contribute to the repository:

```{tableofcontents}
```

## Projects

The repository's contents are organized into **projects**, found in the {{ "[`projects/`]({}projects)".format(repo_tree_url) }} directory.
Here are the currently existing projects:

```{code-cell}
:tags: [remove-input]
import subprocess
from annotutils import repo

with repo.chdir(repo.repo_root()):
  subprocess.run(["tree", "-d", "--noreport", "projects"])
```

As we can see, each project contains 3 directories: `labels/`, `documents/` and `annotations/`, corresponding to the 3 types of objects stored in this repository.

## Documents

Documents represent scientific journal articles; they contain the article's text and some metadata.
They are generated by invoking {{ pubget_home }} with the `--labelbuddy` option.
They are stored in {{ lb }}'s [JSONLines format](https://jeromedockes.github.io/labelbuddy/labelbuddy/current/documentation/#docs-jsonl-format).

Here is an example document (the text is abbreviated for clarity):

```{code-cell}
:tags: [remove-input, output_scroll]
import json

docs_file = repo.repo_root() / "projects" / "participant_demographics" / "documents" / "documents_00001.jsonl"
with open(docs_file, encoding="utf-8") as stream:
    doc = json.loads(next(stream))
doc["text"] = f"{doc['text'][:70]} [ … ]"
print(json.dumps(doc, indent=2, ensure_ascii=False))
```

```{code-cell}
:tags: [remove-cell]
import myst_nb

from annotutils import database

connection = database.get_database_connection()

document_count = connection.execute("select count(*) from document").fetchone()[0]
myst_nb.glue("document_count", document_count)

annotated_document_count = connection.execute("select count(*) from (select distinct doc_id from annotation)").fetchone()[0]
myst_nb.glue("annotated_document_count", annotated_document_count)

```
There are currently {glue:}`document_count` documents in the repository, {glue:}`annotated_document_count` of which are annotated (more details below).

## Labels

Labels are simple tags that can be attached to a portion of a document's text.
They can optionally have a `color` and a `shortcut_key`, used in {{ lb }} when we are annotating a document.
They are stored in {{ lb }}'s [JSON format](https://jeromedockes.github.io/labelbuddy/labelbuddy/current/documentation/#labels-json-format).
Here is an example:

```{code-cell}
:tags: [remove-input, output_scroll]

labels_file = repo.repo_root() / "projects" / "participant_demographics" / "labels" / "labels_n_participants.json"
print(labels_file.read_text("utf-8"))
```

## Annotations

Finally, an annotation is the association of a label to a portion of a document's text.
It is thus 
+++

The data in this repository is in the `projects/` directory and divided into
projects, each of which contains separate directories for `documents/`,
`labels/` and `annotations/`.

Labels are stored in JSON files and documents and annotations are stored in
JSONLines files (one JSON document per line). To load and analyze these
annotations, we can read these files, or we can use the
`scripts/make_database.py` script to collect all data in a SQLite database
(by default in `analysis/data/database.sqlite3`).

Once this is done, we can open a connection to the database to easily obtain
information about labels, documents and annotations contained in this
repository as shown below.

+++

## Total number of annotations in the repository

+++

We can use the `annotutils` package provided in this repository, in
`analysis/annotutils/`, to create the annotations database if necessary and
obtain a connection from Python scripts.

Install it with `pip install -e analysis/annotutils`

```{code-cell}
from annotutils import database

connection = database.get_database_connection()
n_annotations = connection.execute(
    "SELECT COUNT(*) AS n_annotations FROM annotation"
).fetchone()["n_annotations"]

print(f"There are {n_annotations} annotations in the database.")
```

Here are a few example annotations:

```{code-cell}
from annotutils import displays

displays.AnnotationsDisplay(
    connection.execute(
        "SELECT * FROM detailed_annotation WHERE project = 'autism_mri' LIMIT 7"
    ).fetchall()
)
```

## Count label occurrences in each project

+++

This illustrates collecting the results of a query in a pandas DataFrame for
further processing, plotting etc.

+++

We first query the database to obtain how many times each label was used in
each project, and store the results in a DataFrame.

```{code-cell}
import pandas as pd

label_counts = pd.read_sql(
    """
    SELECT project, label.name AS label_name, COUNT(*) AS n_annotations
      FROM annotation
      INNER JOIN label ON annotation.label_id = label.id
      GROUP BY project, label_name
      ORDER BY n_annotations DESC
    """,
    connection,
)
label_counts.head()
```

Next, for each project we display the number of times each label was used in
a bar plot.

```{code-cell}
from matplotlib import pyplot as plt
import seaborn as sns

projects = label_counts.groupby("project")

for project_name, data in projects:
    fig, ax = plt.subplots(figsize=(4, data.shape[0] / 3))
    sns.barplot(
        data=data, x="n_annotations", y="label_name", ax=ax, color="blue"
    )
    ax.set_title(
        f'“{project_name}” project ({data["n_annotations"].sum()} annotations)'
    )
    ax.set_ylabel("")
    sns.despine()
```
