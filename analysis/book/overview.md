---
jupytext:
  text_representation:
    extension: .md
    format_name: myst
    format_version: 0.13
    jupytext_version: 1.14.1
kernelspec:
  display_name: Python 3
  language: python
  name: python3
---
# Biomedical literature annotations

This {{ "[repository]({})".format(repo_url) }} stores manual annotations (a.k.a tagging, labelling) of biomedical scientific publications.
Examples of information that has been annotated in some documents are the number of study participants, their mean age, or the imaging modality.
Such annotations have diverse uses such as studying the evolution of a scientific field's methods, evaluating automatic information extraction systems, or informing meta-analyses.

The documents found here are journal articles from {{ pmc_home }}, collected using {{ pubget_home }}.
The annotations are made with {{ labelbuddy_home }}, and data is stored in {{ lb }}'s (JSON) format.

This page provides a brief overview of the repository's content, and the rest of the documentation illustrates how to use and contribute to the repository:

```{tableofcontents}
```

## Projects

The repository's contents are organized into **projects**, found in the {{ "[`projects/`]({}projects)".format(repo_tree_url) }} directory.
Here are the currently existing projects:

```{code-cell}
:tags: [remove-input]
import subprocess
from annotutils import repo

with repo.chdir(repo.repo_root()):
  subprocess.run(["tree", "-d", "--noreport", "projects"])
```

As we can see, each project contains 3 directories: `labels/`, `documents/` and `annotations/`, corresponding to the 3 types of objects stored in this repository.

## Documents

Documents represent scientific journal articles; they contain the article's text and some metadata.
They are generated by invoking {{ pubget_home }} with the `--labelbuddy` option.
They are stored in {{ lb }}'s [JSONLines format](https://jeromedockes.github.io/labelbuddy/labelbuddy/current/documentation/#docs-jsonl-format).

Here is an example document (the text is abbreviated for clarity):

```{code-cell}
:tags: [remove-input, output_scroll]
import json

docs_file = (
    repo.repo_root()
    / "projects"
    / "participant_demographics"
    / "documents"
    / "documents_00001.jsonl"
)
with open(docs_file, encoding="utf-8") as stream:
    doc = json.loads(next(stream))
doc["text"] = f"{doc['text'][:70]} [ … ]"
print(json.dumps(doc, indent=2, ensure_ascii=False))
```

```{code-cell}
:tags: [remove-cell]
import myst_nb

from annotutils import database

connection = database.get_database_connection()

document_count = connection.execute(
    "select count(*) from document"
).fetchone()[0]
myst_nb.glue("document_count", document_count)

annotated_document_count = connection.execute(
    "select count(*) from (select distinct doc_id from annotation)"
).fetchone()[0]
myst_nb.glue("annotated_document_count", annotated_document_count)
```
There are currently {glue:}`document_count` documents in the repository, {glue:}`annotated_document_count` of which are annotated (more details below).

## Labels

Labels are simple tags that can be attached to a portion of a document's text.
They can optionally have a `color` and a `shortcut_key`, used in {{ lb }} when we are annotating a document.
They are stored in {{ lb }}'s [JSON format](https://jeromedockes.github.io/labelbuddy/labelbuddy/current/documentation/#labels-json-format).
Here is an example:

```{code-cell}
:tags: [remove-input, output_scroll]

labels_file = (
    repo.repo_root()
    / "projects"
    / "participant_demographics"
    / "labels"
    / "labels_n_participants.json"
)
print(labels_file.read_text("utf-8"))
```

## Annotations

Finally, an annotation is the association of a label to a portion of a document's text.
It thus consists of a label name and the character positions where it starts and ends.

Here are a few example annotations:

```{code-cell}
:tags: [remove-input]
from annotutils import displays

displays.AnnotationsDisplay(
    connection.execute(
        "select * from detailed_annotation order by project limit 10;"
    ).fetchall()
)
```

```{code-cell}
:tags: [remove-cell]
annotation_count = connection.execute(
    "SELECT COUNT(*) AS annotation_count FROM annotation"
).fetchone()["annotation_count"]
myst_nb.glue("annotation_count", annotation_count)
```

In total there are {glue:}`annotation_count` annotations in the repository.

## Number of labelled documents by project

Now, we display the number of documents annotated with each label in the different projects:

```{code-cell}
:tags: [remove-cell]
import pandas as pd

label_counts = pd.read_sql(
    """
      with annot as
      (select distinct label_id, doc_id, project from annotation)
    SELECT project, label.name AS label_name, label.color as color, COUNT(*) AS n_docs
    from
      annot
      INNER JOIN label ON annot.label_id = label.id
      INNER JOIN document ON annot.doc_id = document.id
      GROUP BY project, label_name
      ORDER BY n_docs DESC
    """,
    connection,
)

project_counts = pd.read_sql(
    """
    select project, count(*) as n_docs
      from (select distinct project, doc_id from annotation)
      group by project
    """,
    connection,
).set_index("project")["n_docs"]
```


```{code-cell}
:tags: [remove-input]
from matplotlib import pyplot as plt
import seaborn as sns

projects = label_counts.groupby("project")

for project_name, data in projects:
    fig, ax = plt.subplots(figsize=(4, data.shape[0] / 3))
    sns.barplot(
        data=data, x="n_docs", y="label_name", ax=ax, color="blue"
    )
    ax.set_title(
        f'“{project_name}” project ({project_counts[project_name]} annotated documents)'
    )
    ax.set_ylabel("")
    ax.set_xlabel("Number of documents annotated with this label")
    sns.despine()
```
